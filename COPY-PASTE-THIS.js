// ğŸ§ª PDF ANNOTATIONS TEST - PHASES 1-4 | Copy this entire file and paste in browser console (F12)
(async()=>{const l=(e,m,d='')=>console.log(`${e} ${m}`,d),s=m=>new Promise(r=>setTimeout(r,m));let p=0,f=0,t=0;const test=async(n,fn)=>{t++;try{await fn();p++;l('âœ…',n);return true}catch(e){f++;l('âŒ',n,e.message);return false}};l('ğŸš€','Starting PDF Annotations Test...\n');const projectId=window.location.pathname.match(/\/project\/([^\/]+)/)?.[1],userId=JSON.parse(localStorage.getItem('user')||'{}').user_id,apiUrl=window.location.origin.includes('localhost')?'http://localhost:8000':'https://r-dagent-production.up.railway.app',pmid=document.querySelector('[data-pmid]')?.getAttribute('data-pmid')||'12345678';if(!projectId||!userId){l('âŒ','ERROR: Open a PDF in a project first!');return}l('ğŸ“‹','Environment:',{projectId,userId,pmid});console.log('');const ids=[],api={create:async d=>{const r=await fetch(`${apiUrl}/api/projects/${projectId}/annotations`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({project_id:projectId,author_id:userId,pmid,...d})});if(!r.ok)throw new Error(`API error: ${r.status}`);const j=await r.json();ids.push(j.annotation_id);return j},update:async(id,d)=>{const r=await fetch(`${apiUrl}/api/projects/${projectId}/annotations/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});if(!r.ok)throw new Error(`API error: ${r.status}`);return r.json()},delete:async id=>{const r=await fetch(`${apiUrl}/api/projects/${projectId}/annotations/${id}`,{method:'DELETE'});if(!r.ok)throw new Error(`API error: ${r.status}`)},getAll:async()=>{const r=await fetch(`${apiUrl}/api/projects/${projectId}/annotations`);if(!r.ok)throw new Error(`API error: ${r.status}`);return r.json()}};l('ğŸ“','=== PHASE 1: STICKY NOTES ===\n');let sid;await test('Create sticky note',async()=>{const n=await api.create({content:'Test Sticky ğŸ“',annotation_type:'sticky_note',pdf_page:1,sticky_note_position:{x:.5,y:.5,width:200,height:150},sticky_note_color:'#FFEB3B'});sid=n.annotation_id;if(!sid)throw new Error('No ID')});await s(800);await test('Sticky in DOM',async()=>{if(!document.querySelector(`[data-annotation-id="${sid}"]`))throw new Error('Not found')});await test('Move sticky',async()=>{await api.update(sid,{sticky_note_position:{x:.6,y:.6,width:200,height:150}})});await s(800);await test('Resize sticky',async()=>{await api.update(sid,{sticky_note_position:{x:.6,y:.6,width:250,height:180}})});await s(800);await test('Edit sticky',async()=>{await api.update(sid,{content:'Updated âœï¸'})});await s(800);l('ğŸ“','\n=== PHASE 2: UNDERLINE & STRIKETHROUGH ===\n');await test('Create underline',async()=>{await api.create({content:'Underline',annotation_type:'underline',pdf_page:1,pdf_coordinates:{x:.1,y:.2,width:.3,height:.02,pageWidth:612,pageHeight:792},highlight_color:'#2196F3',highlight_text:'Underlined text'})});await s(800);await test('Create strikethrough',async()=>{await api.create({content:'Strike',annotation_type:'strikethrough',pdf_page:1,pdf_coordinates:{x:.1,y:.25,width:.3,height:.02,pageWidth:612,pageHeight:792},highlight_color:'#EF4444',highlight_text:'Strikethrough text'})});await s(800);await test('HighlightLayer exists',async()=>{if(!document.querySelector('[class*="HighlightLayer"]'))throw new Error('Not found')});l('âœï¸','\n=== PHASE 3: RICH TEXT ===\n');let rid;await test('Create HTML sticky',async()=>{const h='<p><strong>Bold</strong> <em>italic</em></p><ul><li>Item 1</li></ul>';const n=await api.create({content:h,annotation_type:'sticky_note',pdf_page:1,sticky_note_position:{x:.7,y:.5,width:250,height:200},sticky_note_color:'#FFEB3B'});rid=n.annotation_id});await s(800);await test('HTML stored',async()=>{const a=await api.getAll(),n=a.find(x=>x.annotation_id===rid);if(!n.content.includes('<strong>'))throw new Error('No HTML')});await test('Update HTML',async()=>{await api.update(rid,{content:'<p><strong>B</strong> <em>I</em></p>'})});await s(800);await test('TipTap editor exists',async()=>{if(!document.querySelector('[class*="ProseMirror"]')&&!document.querySelector('[class*="tiptap"]'))throw new Error('Not found')});l('ğŸ¨','\n=== PHASE 4: HIGHLIGHTS ===\n');const colors=[{n:'Yellow',h:'#FFEB3B'},{n:'Green',h:'#4CAF50'},{n:'Blue',h:'#2196F3'},{n:'Pink',h:'#E91E63'},{n:'Orange',h:'#FF9800'}];for(const c of colors){await test(`Create ${c.n} highlight`,async()=>{await api.create({content:`${c.n} hl`,annotation_type:'highlight',pdf_page:1,pdf_coordinates:{x:.1,y:.4+(colors.indexOf(c)*.05),width:.35,height:.025,pageWidth:612,pageHeight:792},highlight_color:c.h,highlight_text:`${c.n} text`})});await s(300)}await test('All 5 colors created',async()=>{const a=await api.getAll(),h=a.filter(x=>x.annotation_type==='highlight'),u=new Set(h.map(x=>x.highlight_color));if(u.size<5)throw new Error(`Only ${u.size} colors`)});l('ğŸ”„','\n=== INTEGRATION ===\n');await test('All types present',async()=>{const a=await api.getAll(),types=new Set(a.map(x=>x.annotation_type)),req=['highlight','underline','strikethrough','sticky_note'],miss=req.filter(x=>!types.has(x));if(miss.length>0)throw new Error(`Missing: ${miss.join(', ')}`)});await test('Sidebar populated',async()=>{if(document.querySelectorAll('[data-annotation-id]').length===0)throw new Error('No cards')});await test('Toolbar present',async()=>{if(!document.querySelector('[class*="AnnotationToolbar"]')&&!document.querySelector('button[title*="Highlight"]'))throw new Error('Not found')});l('ğŸ§¹','\n=== CLEANUP ===\n');for(const id of ids){await test(`Delete ${id.substring(0,8)}...`,async()=>{await api.delete(id)});await s(200)}console.log('\n'+'='.repeat(70));l('ğŸ“Š','TEST RESULTS');console.log('='.repeat(70));l('âœ…',`Passed: ${p}/${t}`);l('âŒ',`Failed: ${f}/${t}`);l('ğŸ“ˆ',`Success: ${((p/t)*100).toFixed(1)}%`);console.log('='.repeat(70));if(f===0){l('ğŸ‰','ALL TESTS PASSED! Phases 1-4 working! ğŸš€')}else{l('âš ï¸',`${f} test(s) failed`)}console.log('\nâœ¨ Done!\n');return{passed:p,failed:f,total:t}})();

