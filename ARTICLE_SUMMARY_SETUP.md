# Article Summary Feature - Setup Guide

## 🎯 Overview

The Article Summary feature provides AI-powered summaries of research articles when users double-click on paper nodes in the network view. It uses Google Gemini API (free tier) with database caching to minimize API calls and costs.

## ✨ Features

- **Double-click activation**: Users double-click any paper node to see a summary
- **AI-powered summaries**: 5-sentence summaries generated by Gemini 1.5 Flash
- **Cache-first strategy**: Summaries are cached in database and shared across all users
- **Analytics tracking**: Monitors cache hits, API calls, and user engagement
- **Modal UI**: Clean, centered modal with loading, success, and error states
- **View full details**: Users can open the sidebar for complete article information

## 📋 Prerequisites

1. **Google Gemini API Key** (Free tier - no credit card required)
   - Visit: https://aistudio.google.com/app/apikey
   - Create a new API key
   - Free tier includes 1,500 requests/day

2. **Database Migration** (PostgreSQL or SQLite)
   - Adds 4 columns to `articles` table
   - Creates `summary_analytics` table

## 🚀 Setup Instructions

### Step 1: Get Google Gemini API Key

1. Go to [Google AI Studio](https://aistudio.google.com/app/apikey)
2. Sign in with your Google account
3. Click "Create API Key"
4. Copy the API key

### Step 2: Add Environment Variable

Add to your `.env` file (backend):

```bash
GEMINI_API_KEY=your_api_key_here
```

Add to your `.env.local` file (frontend):

```bash
GEMINI_API_KEY=your_api_key_here
NEXT_PUBLIC_BACKEND_URL=http://localhost:8000
```

For production (Railway/Vercel), add the environment variable in your deployment dashboard.

### Step 3: Run Database Migration

```bash
cd migrations
python add_article_summary_columns.py upgrade
```

This will:
- Add `ai_summary`, `summary_generated_at`, `summary_model`, `summary_version` columns to `articles` table
- Create `summary_analytics` table for tracking usage
- Create necessary indexes for performance

To verify migration:
```bash
python add_article_summary_columns.py verify
```

To check status:
```bash
python add_article_summary_columns.py status
```

To rollback (if needed):
```bash
python add_article_summary_columns.py downgrade
```

### Step 4: Install Frontend Dependencies

The modal component uses Heroicons. If not already installed:

```bash
cd frontend
npm install @heroicons/react
```

### Step 5: Restart Services

**Backend:**
```bash
# Development
uvicorn main:app --reload

# Production (Railway)
# Will restart automatically on deployment
```

**Frontend:**
```bash
# Development
cd frontend
npm run dev

# Production (Vercel)
cd frontend
npm run build
npx vercel --prod
```

## 🧪 Testing

### Test the Feature

1. **Open Network View**
   - Navigate to any network view (Dashboard → Project → Collections → Paper → Network View)
   - Or via Collections tab → Collection → Paper → Network View

2. **Double-click a Paper Node**
   - Double-click any paper node in the network graph
   - Modal should appear with "Generating summary..." loading state

3. **Verify Summary Generation**
   - First time: Summary should be generated via Gemini API (~2-3 seconds)
   - Subsequent times: Summary should load instantly from cache

4. **Test Actions**
   - Click "View Full Details in Sidebar" → Should close modal and open sidebar
   - Click X or press ESC → Should close modal
   - Click outside modal → Should close modal

### Test Cache Hit Rate

After using the feature for a few days, check analytics:

```bash
curl http://localhost:8000/api/analytics/summary-stats?days=7
```

Expected cache hit rate after 1 week: 70-80%

### Test Error Handling

Try double-clicking a paper that has no abstract in PubMed:
- Should show error message: "No abstract available"
- Should still offer "View Full Details" button

## 📊 Monitoring & Analytics

### View Summary Statistics

**Backend endpoint:**
```bash
GET /api/articles/summaries/stats
```

Returns:
- Total articles in database
- Articles with summaries
- Cache coverage percentage
- Model distribution

**Analytics endpoint:**
```bash
GET /api/analytics/summary-stats?days=7
```

Returns:
- Total views
- Cache hit rate
- Most viewed papers
- Event distribution (cache_hit, generated, no_abstract, error)
- Daily breakdown

### User-specific Analytics

```bash
GET /api/analytics/summary-stats/user/{user_id}?days=30
```

Returns:
- User's total views
- Papers viewed by user
- Event distribution for user

## 🔧 Configuration

### Adjust Summary Length

Edit `frontend/src/app/api/proxy/articles/[pmid]/summary/route.ts`:

```typescript
const prompt = `Summarize this research paper in exactly 5 sentences...`
```

Change "5 sentences" to desired length (e.g., "3 sentences", "7 sentences").

### Change AI Model

Edit the same file:

```typescript
const response = await fetch(
  `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
  // ...
);
```

Available models:
- `gemini-1.5-flash` (fastest, recommended)
- `gemini-1.5-pro` (more detailed, slower)
- `gemini-1.0-pro` (older, less capable)

### Adjust Modal Styling

Edit `frontend/src/components/ArticleSummaryModal.tsx`:

```typescript
<div className="bg-white rounded-lg shadow-xl w-full max-w-md">
```

Change `max-w-md` to:
- `max-w-sm` (smaller)
- `max-w-lg` (larger)
- `max-w-xl` (extra large)

## 📈 Expected Performance

### API Usage (Free Tier Limits)

- **Free tier**: 1,500 requests/day
- **Expected usage after week 1**: 20-60 requests/day (70-80% cache hit rate)
- **Cost**: $0/month (stays within free tier)

### Response Times

- **Cache hit**: <100ms
- **Cache miss (first generation)**: 2-3 seconds
- **PubMed fetch**: ~500ms
- **Gemini API call**: ~1.5-2 seconds

### Database Impact

- **Storage per summary**: ~500-1000 bytes
- **1000 summaries**: ~1 MB
- **Analytics per event**: ~100 bytes
- **10,000 events**: ~1 MB

## 🐛 Troubleshooting

### "GEMINI_API_KEY not configured"

**Solution**: Add `GEMINI_API_KEY` to your environment variables and restart the server.

### "Failed to fetch summary"

**Possible causes:**
1. Backend not running
2. CORS issues (check ALLOW_ORIGIN_REGEX)
3. Database connection issues

**Solution**: Check backend logs for detailed error messages.

### "No abstract available"

**Cause**: The article doesn't have an abstract in PubMed.

**Solution**: This is expected behavior. User can still view full details in sidebar.

### Modal not appearing on double-click

**Possible causes:**
1. JavaScript error in console
2. Modal state not updating
3. Event handler not attached

**Solution**: 
1. Check browser console for errors
2. Verify `ArticleSummaryModal` is imported in `NetworkView.tsx`
3. Check that `showSummaryModal` state is being set

### Cache not working

**Possible causes:**
1. Database migration not run
2. Backend router not registered
3. Database connection issues

**Solution**:
1. Run migration: `python migrations/add_article_summary_columns.py verify`
2. Check backend logs for router registration message
3. Test database connection

## 📝 API Endpoints

### Frontend (Next.js API Routes)

- `GET /api/proxy/articles/[pmid]/summary` - Get or generate summary

### Backend (FastAPI)

- `GET /api/articles/{pmid}/summary` - Get cached summary
- `POST /api/articles/{pmid}/summary` - Cache a summary
- `DELETE /api/articles/{pmid}/summary` - Delete cached summary (admin)
- `GET /api/articles/summaries/stats` - Get summary statistics
- `POST /api/analytics/summary-view` - Track summary view event
- `GET /api/analytics/summary-stats` - Get analytics statistics
- `GET /api/analytics/summary-stats/user/{user_id}` - Get user-specific stats

## 🎨 UI/UX Details

### Modal States

1. **Loading**: Spinner + "Generating summary..." text
2. **Success**: 🤖 icon + summary text + "View Full Details" button
3. **Error**: ⚠️ icon + error message + "View Full Details" button (if applicable)

### User Actions

- **Double-click paper node** → Open summary modal
- **Single-click paper node** → Open sidebar (existing behavior)
- **ESC key** → Close modal
- **Click outside modal** → Close modal
- **Click X button** → Close modal
- **Click "View Full Details"** → Close modal + open sidebar

### Accessibility

- Keyboard navigation (ESC to close)
- Focus management
- ARIA labels
- Screen reader friendly

## 🔐 Security Considerations

1. **API Key Protection**: Never expose GEMINI_API_KEY in frontend code
2. **Rate Limiting**: Free tier has 1,500 requests/day limit
3. **Input Validation**: PMID validation in backend
4. **SQL Injection**: Using parameterized queries
5. **CORS**: Properly configured for production domains

## 📚 Additional Resources

- [Google Gemini API Documentation](https://ai.google.dev/docs)
- [Gemini API Pricing](https://ai.google.dev/pricing)
- [PubMed eUtils API](https://www.ncbi.nlm.nih.gov/books/NBK25501/)

## 🎉 Success Criteria

✅ Users can double-click any paper node to see AI summary
✅ Summaries load in <3 seconds on first generation
✅ Summaries load in <100ms from cache
✅ Cache hit rate reaches 70-80% after 1 week
✅ API usage stays within free tier (1,500 requests/day)
✅ Modal UI is responsive and accessible
✅ Analytics tracking works correctly
✅ Error handling is graceful

## 🚀 Next Steps

After successful deployment:

1. **Monitor analytics** for first week to verify cache hit rate
2. **Gather user feedback** on summary quality and length
3. **Optimize prompt** if needed for better summaries
4. **Consider adding** summary regeneration option (if users request it)
5. **Explore** other free LLM options if Gemini limits are reached

